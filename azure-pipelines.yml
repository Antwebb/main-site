trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:

- task: Docker@2
  displayName: Login to Docker Hub
  inputs:
    command: login
    containerRegistry: DockerHub

- task: DotNetCoreInstaller@0
  inputs:
    packageType: 'sdk'
    version: '2.2.104' 

- script: dotnet run src dist
  displayName: 'Running Build'

- script: dotnet test --logger:trx
  displayName: 'Running Tests'

- script: docker build -t steelbuild/main-site:$(Build.BuildId) .
- script: docker tag steelbuild/main-site:$(Build.BuildId) steelbuild/main-site:latest

- script: docker push steelbuild/main-site:$(Build.BuildId)
- script: docker push steelbuild/main-site:latest

- task: PublishBuildArtifacts@1
  inputs:
    pathtoPublish: 'dist'
    artifactName: drop

- task: PublishTestResults@2
  condition: succededOrFailed()
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/TEST-*.trx' 